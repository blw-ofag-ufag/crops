<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Multi‚ÄëLanguage LINDAS Entity Search</title>

  <!-- Bootstrap CSS & Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    :root {
      --accent: #239ea7; /* mint */
      --accent-light: #e6f7f3;
    }

    body {
      background: #ffffff; /* flat white */
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }

    /* ---------- layout ---------- */
    .main-container {
      margin: 2rem auto;
      padding: 2rem;
      max-width: 1000px; /* a bit wider */
    }

    /* ---------- header ---------- */
    #headerTitle {
      font-size: 2rem;
      font-weight: 600;
      color: var(--accent);
    }
    .header-lead { color: #6c757d; }

    /* language selector */
    .lang-select {
      width: auto;
      min-width: 120px;
    }

    /* ---------- search ---------- */
    .search-input {
      border-radius: 8px;
      padding: 0.75rem 1rem;
      border: 1px solid #ced4da;
    }
    .search-input:focus {
      border-color: var(--accent);
      box-shadow: var(--accent);
    }

    /* stats paragraph */
    #resultsStats { margin-top: .5rem; }

    /* ---------- table ---------- */
    .entity-table { border: 1px solid #dee2e6; }
    .entity-table thead th {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 0.75rem;
      text-transform: uppercase;
      font-size: 0.85rem;
    }
    .entity-table tbody td { padding: 0.75rem; vertical-align: middle; }
    .entity-table tbody tr:hover { background: #f8f9fa; }
    .entity-link { color: var(--accent); text-decoration: none; font-weight: bold; }
    .entity-link:hover { text-decoration: underline; }
    .abbreviation { color: #6c757d; }
    
    /* New styles for identifiers and tags */
    .identifier {
      background-color: #e9ecef;
      color: #495057;
      padding: 0.2em 0.4em;
      border-radius: 3px;
      font-family: Menlo, Monaco, Consolas, "Courier New", monospace;
      font-size: 0.85em;
      margin-right: 0.4em;
      margin-bottom: 0.4em;
      display: inline-block;
    }
    .tag {
      display: inline-block;
      background-color: var(--accent-light);
      color: var(--accent);
      padding: 0.25em 0.6em;
      border-radius: 10px;
      font-size: 0.8em;
      font-weight: 600;
      margin-right: 0.4em;
      margin-bottom: 0.4em;
    }

    /* ---------- misc ---------- */
    .loading-spinner { display: flex; justify-content: center; padding: 2rem 0; }
    .spinner-border { border-color: var(--accent); border-right-color: transparent; }
    .no-results { text-align: center; color: #6c757d; padding: 2rem 0; }
    kbd {
      background-color: var(--accent);
      color: #fff;
      padding: 0.2rem 0.45rem;
      border-radius: 0.25rem;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="main-container">

    <!-- header + language selector -->
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div class="flex-grow-1 me-3">
        <h1 id="headerTitle"><i class="bi bi-search"></i> <span id="titleText">LINDAS Entity Search</span></h1>
        <p class="header-lead" id="leadText">Search through agricultural system map entities with multilingual support</p>
      </div>
      <select id="langSelect"
              class="form-select form-select-sm lang-select flex-shrink-0"
              aria-label="Select language">
        <option value="de">Deutsch</option>
        <option value="fr">Fran√ßais</option>
        <option value="it">Italiano</option>
        <option value="en" selected>English</option>
      </select>
    </div>
    
    <!-- search box -->
    <input type="text" id="search" class="form-control search-input" placeholder="üîç Search for agricultural entities‚Ä¶" />
    <p id="resultsStats" class="text-muted small"></p>

    <!-- results table placeholder -->
    <div id="resultsTable" class="mt-3"></div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
  <script>
    /* ---------- translations ---------- */
    const translations = {
      en: {
        title: "LINDAS Entity Search",
        lead: "Search entities with multilingual support. Type whatever you're searching for into the search field. When you hit <kbd>ENTER</kbd>, all results will be fetched.",
        placeholder: "Search for entities...",
        entityName: "Entity Name",
        identifiers: "Identifiers",
        tags: "Tags",
        noResultsHeader: "No results found",
        noResultsText: "Try adjusting your search terms or selecting a different language."
      },
      de: {
        title: "LINDAS-Entit√§tensuche",
        lead: "Durchsuche Entit√§ten mit mehrsprachiger Unterst√ºtzung. Gib einfach ins Suchfeld ein, wonach du suchst. Wenn du <kbd>ENTER</kbd> dr√ºckst, werden alle Ergebnisse abgerufen.",
        placeholder: "Nach Entit√§t suchen...",
        entityName: "Entit√§tsname",
        identifiers: "Identifikatoren",
        tags: "Klassen",
        noResultsHeader: "Keine Ergebnisse",
        noResultsText: "Passen Sie Ihre Suchbegriffe an oder w√§hlen Sie eine andere Sprache."
      },
      fr: {
        title: "Recherche d'entit√©s LINDAS",
        lead: "Recherchez les entit√©s avec prise en charge multilingue. Tapez ce que vous recherchez dans le champ de recherche. Lorsque vous appuyez sur <kbd>ENTER</kbd>, tous les r√©sultats seront r√©cup√©r√©s.",
        placeholder: "Rechercher des entit√©s...",
        entityName: "Nom de l'entit√©",
        identifiers: "Identifiants",
        tags: "Classes",
        noResultsHeader: "Aucun r√©sultat",
        noResultsText: "Essayez de modifier vos termes de recherche ou de changer de langue."
      },
      it: {
        title: "Ricerca entit√† LINDAS",
        lead: "Cerca tra le entit√† con supporto multilingue. Digita nel campo di ricerca ci√≤ che stai cercando. Quando premi <kbd>ENTER</kbd>, verranno recuperati tutti i risultati.",
        placeholder: "Cerca entit√†...",
        entityName: "Nome entit√†",
        identifiers: "Identificatori",
        tags: "Classi",
        noResultsHeader: "Nessun risultato",
        noResultsText: "Prova a modificare i termini di ricerca o a selezionare un'altra lingua."
      }
    };

    /* ---------- helpers ---------- */
    function getLang() { return document.getElementById("langSelect").value; }
    function updateStatic(lang) {
      const t = translations[lang] || translations.en;
      document.title = t.title;
      document.getElementById("titleText").innerHTML = t.title;
      document.getElementById("leadText").innerHTML = t.lead;
      document.getElementById("search").placeholder = t.placeholder;
    }

    /* ---------- data queries ---------- */
    async function fetchFullEntities(query) {
      const language = getLang();
      const terms = query.split(/\s+/).filter(Boolean);
      const termFilter = terms
        .map(
          term =>
            `(REGEX(?label, "${term}", "i") || (BOUND(?abbr) && REGEX(?abbr, "${term}", "i")))`
        )
        .join(" && ");

      const sparql = `
        PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
        PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
        PREFIX schema: <http://schema.org/>
        PREFIX : <https://agriculture.ld.admin.ch/crops/>
        SELECT
          ?subject ?label
          (GROUP_CONCAT(DISTINCT ?classname; separator="||") as ?classes)
          (GROUP_CONCAT(DISTINCT CONCAT(?system, ":", xsd:string(?id)); separator="||") as ?identifiers)
        WHERE {
          GRAPH <https://lindas.admin.ch/foag/crops> {
            ?subject schema:name ?label .
            FILTER(LANG(?label) = "${language}")

            ?subject a ?class .
            ?class rdfs:subClassOf* :CultivationType .
            ?class schema:name ?classname .
            FILTER(LANG(?classname) = "${language}")
            OPTIONAL {
              ?subject schema:identifier ?identifierNode .
              ?identifierNode schema:value ?id .
              ?identifierNode schema:name ?system .
            }
            FILTER(${termFilter})
          }
        }
        GROUP BY ?subject ?label ?abbr`;
      
      const url = `https://lindas.admin.ch/query?query=${encodeURIComponent(sparql)}&format=json`;
      try {
        const res = await fetch(url, { headers: { Accept: "application/sparql-results+json" } });
        if (!res.ok) return [];
        const json = await res.json();
        
        return json.results.bindings.map(b => ({
          id: b.subject.value,
          label: b.label.value,
          abbreviation: b.abbr ? b.abbr.value : "",
          classes: b.classes ? b.classes.value.split('||') : [],
          identifiers: b.identifiers ? b.identifiers.value.split('||') : []
        }));
      } catch (err) {
        console.error(err);
        return [];
      }
    }

    function renderTable(data) {
      const lang = getLang();
      const t = translations[lang] || translations.en;
      const container = document.getElementById("resultsTable");
      container.innerHTML = "";
      if (!data.length) {
        container.innerHTML = `<div class="no-results"><i class="bi bi-search" style="font-size:2rem;"></i><h5 class="mt-2">${t.noResultsHeader}</h5><p>${t.noResultsText}</p></div>`;
        return;
      }
      const table = document.createElement("table");
      table.className = "table entity-table";
      table.innerHTML = `
        <thead>
          <tr>
            <th style="width:35%"><i class="bi bi-tag me-2"></i>${t.entityName}</th>
            <th style="width:35%"><i class="bi bi-hash me-2"></i>${t.identifiers}</th>
            <th style="width:30%"><i class="bi bi-bookmark-star me-2"></i>${t.tags}</th>
          </tr>
        </thead>`;
      
      const tbody = document.createElement("tbody");
      data.forEach(r => {
        const tr = document.createElement("tr");
        
        // Column 1: Entity Name
        const nameTd = document.createElement("td");
        nameTd.innerHTML = `<a href="${r.id}" target="_blank" class="entity-link">${r.label}</a>${r.abbreviation ? ` <span class="abbreviation">(${r.abbreviation})</span>` : ""}`;
        
        // Column 2: Identifiers
        const identifiersTd = document.createElement("td");
        if (r.identifiers && r.identifiers.length > 0) {
          identifiersTd.innerHTML = r.identifiers.map(id => `<code class="identifier">${id}</code>`).join("");
        } else {
          identifiersTd.textContent = "‚Äî";
        }
        
        // Column 3: Tags
        const tagsTd = document.createElement("td");
        if (r.classes && r.classes.length > 0) {
          tagsTd.innerHTML = r.classes.map(cls => `<span class="tag">${cls}</span>`).join("");
        } else {
          tagsTd.textContent = "‚Äî";
        }

        tr.appendChild(nameTd);
        tr.appendChild(identifiersTd);
        tr.appendChild(tagsTd);
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      container.appendChild(table);
    }

    function showStats(count, elapsed) {
      document.getElementById("resultsStats").textContent = `${count} entities found in ${elapsed.toFixed(2)}s`;
    }

    async function runSearch(query) {
      if (query.length < 2) return;
      const params = new URLSearchParams(location.search);
      params.set("query", query);
      params.set("lang", getLang());
      history.replaceState({}, "", `?${params.toString()}`);
      document.getElementById("resultsStats").textContent = "";
      document.getElementById("resultsTable").innerHTML = `<div class="loading-spinner"><div class="spinner-border" role="status"><span class="visually-hidden">Loading‚Ä¶</span></div></div>`;
      const t0 = performance.now();
      const data = await fetchFullEntities(query);
      const elapsed = (performance.now() - t0) / 1000;
      renderTable(data);
      if (data.length) showStats(data.length, elapsed);
    }

    document.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(location.search);
      const storedLang = params.get("lang") || "de";
      const storedQuery = params.get("query") || "";
      document.getElementById("langSelect").value = storedLang;
      updateStatic(storedLang);
      const searchBox = document.getElementById("search");
      searchBox.addEventListener("keydown", e => { if (e.key === "Enter") runSearch(e.target.value.trim()); });
      document.getElementById("langSelect").addEventListener("change", e => {
        const lang = e.target.value;
        updateStatic(lang);
        const url = new URL(location.href);
        url.searchParams.set("lang", lang);
        history.replaceState({}, "", url);
      });
      if (storedQuery.length >= 2) {
        searchBox.value = storedQuery;
        runSearch(storedQuery);
      }
    });
  </script>
</body>
</html>